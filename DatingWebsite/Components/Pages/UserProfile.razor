@page "/user/{UserId}"
@inject NavigationManager Navigation

<div style="max-width: 800px; margin: 30px auto;">
    <div style="margin-bottom: 20px;">
        <button onclick="goBackToSearch()"
                style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
            ← Назад к поиску
        </button>
    </div>

    <div style="background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background: #e75480; color: white; padding: 25px 30px;">
            <h2 style="margin: 0; font-size: 28px;" id="profileTitle">Профиль пользователя</h2>
        </div>

        <div style="padding: 30px;" id="userProfileContent">
            <div style="text-align: center; padding: 50px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">⏳</div>
                <h3 style="color: #2c3e50;">Загрузка профиля...</h3>
                <p>Пожалуйста, подождите</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        console.log('UserProfile.razor загружен');
        loadUserProfile();
    });

    function loadUserProfile() {
        console.log('Загрузка профиля пользователя...');

        // Получаем ID из URL
        const path = window.location.pathname;
        const match = path.match(/\/user\/(\d+)/);

        if (!match) {
            showError('Неверный URL профиля');
            return;
        }

        const userId = match[1];
        console.log('ID пользователя из URL:', userId);

        // Получаем пользователя (без рекурсии!)
        const user = findUserById(userId);

        if (!user) {
            showError('Пользователь не найден');
            return;
        }

        console.log('Пользователь найден:', user);
        renderUserProfile(user);
    }

    // Изменено название функции чтобы избежать конфликта
    function findUserById(userId) {
        try {
            // Сначала проверяем, есть ли функция в users.js (не наше window!)
            // users.js добавляет свои функции в глобальную область видимости
            if (typeof getAllUsers === 'function') {
                console.log('Использую функцию из users.js');
                const users = getAllUsers();
                const user = users.find(function(u) {
                    return String(u.id) === String(userId);
                });
                return user;
            }

            // Локальная реализация
            console.log('Использую локальную реализацию поиска');
            const users = JSON.parse(localStorage.getItem('datingWebsiteUsers') || '[]');
            console.log('Всего пользователей в localStorage:', users.length);

            // Ищем пользователя (сравниваем как строки)
            const user = users.find(function(u) {
                console.log('Сравниваю:', String(u.id), 'с', String(userId));
                return String(u.id) === String(userId);
            });

            if (user) {
                console.log('Найден пользователь:', user);
                return {
                    id: user.id.toString(),
                    firstName: user.firstName || '',
                    lastName: user.lastName || '',
                    age: user.age || 0,
                    email: user.email || '',
                    description: user.description || '',
                    lookingFor: user.lookingFor || '',
                    interests: user.interests || []
                };
            }

            console.log('Пользователь не найден');
            return null;
        } catch (error) {
            console.error('Ошибка при поиске пользователя:', error);
            return null;
        }
    }

    function renderUserProfile(user) {
        const container = document.getElementById('userProfileContent');
        if (!container) return;

        // Обновляем заголовок
        const title = document.getElementById('profileTitle');
        if (title) {
            title.textContent = 'Профиль: ' + user.firstName + ' ' + user.lastName;
        }

        // Создаем инициалы
        const firstName = user.firstName || '';
        const lastName = user.lastName || '';
        const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();

        // Создаем HTML безопасным способом
        let html = '';

        // Основная информация
        html += '<div style="text-align: center; margin-bottom: 40px;">';
        html += '<div style="width: 120px; height: 120px; background: #e75480; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 20px auto;">';
        html += initials;
        html += '</div>';
        html += '<h3 style="margin: 0 0 10px 0; color: #2c3e50;">' + user.firstName + ' ' + user.lastName + '</h3>';
        html += '<div style="color: #666; margin-bottom: 5px;">Возраст: ' + user.age + ' лет</div>';
        html += '<div style="color: #666; margin-bottom: 15px;">Email: ' + user.email + '</div>';
        html += '</div>';

        // Описание
        if (user.description) {
            html += '<div style="margin-bottom: 30px;">';
            html += '<h4 style="color: #2c3e50; margin-bottom: 15px;">О себе</h4>';
            html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; color: #666; line-height: 1.6;">';
            html += user.description;
            html += '</div>';
            html += '</div>';
        }

        // Цели
        if (user.lookingFor) {
            html += '<div style="margin-bottom: 30px;">';
            html += '<h4 style="color: #2c3e50; margin-bottom: 15px;">Ищет</h4>';
            html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; color: #666;">';
            html += user.lookingFor;
            html += '</div>';
            html += '</div>';
        }

        // Интересы
        if (user.interests && user.interests.length > 0) {
            html += '<div style="margin-bottom: 30px;">';
            html += '<h4 style="color: #2c3e50; margin-bottom: 15px;">Интересы</h4>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';

            for (let i = 0; i < user.interests.length; i++) {
                html += '<span style="background: #17a2b8; color: white; padding: 8px 15px; border-radius: 20px;">' + user.interests[i] + '</span>';
            }

            html += '</div>';
            html += '</div>';
        }

        // Кнопки действий
        html += '<div style="display: flex; gap: 15px; justify-content: center; margin-top: 40px;">';
        html += '<button onclick="sendMessageToProfileUser(\'' + user.id + '\')"';
        html += 'style="background: #e75480; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">';
        html += '💬 Написать сообщение';
        html += '</button>';
        html += '</div>';

        container.innerHTML = html;
    }

    function showError(message) {
        const container = document.getElementById('userProfileContent');
        if (!container) return;

        const errorHtml = '<div style="text-align: center; padding: 50px; color: #dc3545;">' +
            '<div style="font-size: 48px; margin-bottom: 20px;">❌</div>' +
            '<h3>Ошибка</h3>' +
            '<p>' + message + '</p>' +
            '<button onclick="goBackToSearch()"' +
            'style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 15px;">' +
            'Вернуться к поиску' +
            '</button>' +
            '</div>';

        container.innerHTML = errorHtml;
    }

    // Глобальная функция для отправки сообщения
    window.sendMessageToProfileUser = function(userId) {
        console.log('Отправка сообщения пользователю ID:', userId);

        const user = findUserById(userId);
        if (!user) {
            alert('Пользователь не найден');
            return;
        }

        // Используем функцию из Search.razor (она уже глобальная)
        if (typeof window.sendMessageToUser === 'function') {
            window.sendMessageToUser(userId);
        } else {
            // Резервный вариант
            createChatForUser(userId, user);
        }
    };

    function createChatForUser(userId, user) {
        const chatsJson = localStorage.getItem('datingWebsiteChats') || '[]';
        let chats = JSON.parse(chatsJson);

        let chat = chats.find(function(c) {
            return String(c.userId) === String(userId);
        });

        if (!chat) {
            chat = {
                id: Date.now().toString(),
                userId: userId.toString(),
                userName: user.firstName + ' ' + user.lastName,
                lastMessage: "",
                lastMessageTime: new Date().toISOString(),
                unreadCount: 0
            };
            chats.push(chat);
            localStorage.setItem('datingWebsiteChats', JSON.stringify(chats));
        }

        window.location.href = '/chat/' + chat.id;
    }

    // Глобальная функция для кнопки "Назад"
    window.goBackToSearch = function() {
        console.log('Возвращаемся к поиску');
        window.location.href = '/search';
    };
</script>

@code {
    [Parameter]
    public string UserId { get; set; } = string.Empty;
}