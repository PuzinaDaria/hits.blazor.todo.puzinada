@page "/register"
@* Без @rendermode - используем статический рендеринг *@
@inject NavigationManager Navigation

<div style="max-width: 800px; margin: 30px auto;">
    <!-- Карточка регистрации -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden;">
        <!-- Заголовок -->
        <div style="background: #e75480; color: white; padding: 25px 30px;">
            <h2 style="margin: 0; font-size: 28px;">Регистрация</h2>
        </div>

        <!-- Форма -->
        <div style="padding: 30px;">
            <form id="registerForm">
                <!-- Имя и Фамилия -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Имя *</label>
                        <input type="text" id="firstName" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Фамилия *</label>
                        <input type="text" id="lastName" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                </div>

                <!-- Возраст и Кого ищет -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Возраст *</label>
                        <input type="number" id="age" min="18" max="100" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Кого ищу *</label>
                        <select id="lookingFor" required
                                style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;">
                            <option value="">Выберите...</option>
                            <option value="Друга">Друга</option>
                            <option value="Девушку">Девушку</option>
                            <option value="Парня">Парня</option>
                            <option value="Серьезные отношения">Серьезные отношения</option>
                            <option value="Просто общение">Просто общение</option>
                        </select>
                    </div>
                </div>

                <!-- Email -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Email *</label>
                    <input type="email" id="email" required
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                </div>

                <!-- Пароли -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Пароль *</label>
                        <input type="password" id="password" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Подтверждение *</label>
                        <input type="password" id="confirmPassword" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                </div>

                <!-- Предпочтительный возраст -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Предпочтительный возраст *</label>
                    <select id="preferredAge" required
                            style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;">
                        <option value="">Выберите...</option>
                        <option value="18-25">18-25 лет</option>
                        <option value="26-35">26-35 лет</option>
                        <option value="36-45">36-45 лет</option>
                        <option value="46+">46+ лет</option>
                        <option value="Любой">Любой</option>
                    </select>
                </div>

                <!-- О себе -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">О себе</label>
                    <textarea id="description" rows="3"
                              style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                </div>

                <!-- Интересы -->
                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Интересы</label>
                    <div style="margin-bottom: 10px;">
                        <!-- КНОПКА ДЛЯ ВЫБОРА ИНТЕРЕСОВ - РАБОЧАЯ! -->
                        <button type="button" id="selectInterestsBtn"
                                style="background: white; color: #e75480; border: 2px solid #e75480; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <span>🏷️</span>
                            <span>Выбрать интересы</span>
                        </button>

                        <span id="interestsCount" style="background: #e75480; color: white; padding: 5px 12px; border-radius: 20px; margin-left: 15px; font-size: 14px; display: none;">
                            Выбрано: <span id="selectedCount">0</span>
                        </span>
                    </div>

                    <div id="selectedInterestsContainer" style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: none;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Выбранные интересы:</div>
                        <div id="interestsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- Сюда будут добавляться выбранные интересы -->
                        </div>
                    </div>
                </div>

                <!-- Кнопки -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button type="submit"
                            style="background: #e75480; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;">
                        <span style="margin-right: 10px;">📝</span>
                        Зарегистрироваться
                    </button>

                    <NavLink href="/login" style="text-align: center; color: #e75480; text-decoration: none; padding: 10px;">
                        Уже есть аккаунт? Войти
                    </NavLink>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно интересов -->
<div id="interestsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; width: 90%; max-width: 800px; max-height: 80vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
        <!-- Заголовок модалки -->
        <div style="background: #e75480; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 22px;">Выбор интересов</h3>
            <button type="button" id="closeModalBtn"
                    style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0;">
                ×
            </button>
        </div>

        <!-- Содержимое модалки -->
        <div id="interestsContainer" style="flex: 1; overflow-y: auto; padding: 20px 30px;">
            <!-- Интересы будут добавлены через JavaScript -->
        </div>

        <!-- Футер модалки -->
        <div style="padding: 20px 30px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 12px;">
            <button type="button" id="cancelModalBtn"
                    style="background: #6c757d; color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer;">
                Отмена
            </button>
            <button type="button" id="saveInterestsBtn"
                    style="background: #e75480; color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer;">
                Сохранить
            </button>
        </div>
    </div>
</div>

<!-- JavaScript для работы модального окна и регистрации -->
<script>
    // Глобальные переменные
    let selectedInterests = [];

    // Список доступных интересов
    const availableInterests = [
        "Кино", "Музыка", "Книги", "Спорт", "Путешествия",
        "Фотография", "Кулинария", "Программирование", "Игры", "Танцы",
        "Животные", "Наука", "Искусство", "Мода", "Автомобили",
        "Йога", "Садоводство", "Шахматы", "История", "Психология"
    ];

    // Глобальные функции для работы с модальным окном
    function showInterestsModal() {
        console.log('showInterestsModal вызвана');
        const modal = document.getElementById('interestsModal');
        const container = document.getElementById('interestsContainer');

        if (modal) {
            modal.style.display = 'flex';
            populateInterests();
        }
    }

    function closeInterestsModal() {
        console.log('closeInterestsModal вызвана');
        const modal = document.getElementById('interestsModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function toggleInterest(interestName) {
        console.log(`toggleInterest: ${interestName}`);

        if (selectedInterests.includes(interestName)) {
            // Удаляем из выбранных
            selectedInterests = selectedInterests.filter(i => i !== interestName);
        } else {
            // Добавляем в выбранные
            selectedInterests.push(interestName);
        }

        console.log('Текущие выбранные интересы:', selectedInterests);
    }

    function saveSelectedInterests() {
        console.log('saveSelectedInterests вызвана');
        console.log('Сохранены интересы:', selectedInterests);
        updateInterestsDisplay();
        closeInterestsModal();
    }

    function populateInterests() {
        const container = document.getElementById('interestsContainer');
        if (!container) return;

        container.innerHTML = '';

        // Создаем сетку для интересов
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
        grid.style.gap = '15px';

        // Добавляем каждый интерес
        availableInterests.forEach((interest, index) => {
            const item = document.createElement('div');
            item.style.cssText = 'display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `interest-${index}`;
            checkbox.checked = selectedInterests.includes(interest);
            checkbox.style.cssText = 'margin-right: 12px; width: 18px; height: 18px; cursor: pointer;';

            // Обработчик для чекбокса
            checkbox.addEventListener('click', function(event) {
                event.stopPropagation(); // Предотвращаем всплытие
                toggleInterest(interest);
            });

            const label = document.createElement('label');
            label.htmlFor = `interest-${index}`;
            label.textContent = interest;
            label.style.cssText = 'flex: 1; cursor: pointer;';

            // Обработчик для клика на весь элемент
            item.addEventListener('click', function(event) {
                if (event.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    toggleInterest(interest);
                }
            });

            item.appendChild(checkbox);
            item.appendChild(label);
            grid.appendChild(item);
        });

        container.appendChild(grid);
    }

    function updateInterestsDisplay() {
        const countSpan = document.getElementById('selectedCount');
        const interestsCount = document.getElementById('interestsCount');
        const container = document.getElementById('selectedInterestsContainer');
        const list = document.getElementById('interestsList');

        if (!countSpan || !interestsCount || !container || !list) return;

        if (selectedInterests.length > 0) {
            // Обновляем счетчик
            countSpan.textContent = selectedInterests.length;
            interestsCount.style.display = 'inline-block';

            // Обновляем список интересов
            list.innerHTML = '';
            selectedInterests.forEach(interest => {
                const badge = document.createElement('span');
                badge.textContent = interest;
                badge.style.cssText = 'background: #17a2b8; color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px;';
                list.appendChild(badge);
            });

            // Показываем контейнер
            container.style.display = 'block';
        } else {
            // Скрываем элементы
            interestsCount.style.display = 'none';
            container.style.display = 'none';
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Страница регистрации загружена');

        // Инициализируем модальное окно интересов
        const selectBtn = document.getElementById('selectInterestsBtn');
        const closeBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelModalBtn');
        const saveBtn = document.getElementById('saveInterestsBtn');
        const modal = document.getElementById('interestsModal');

        if (selectBtn) {
            selectBtn.addEventListener('click', showInterestsModal);
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', closeInterestsModal);
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', closeInterestsModal);
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', saveSelectedInterests);
        }

        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeInterestsModal();
                }
            });
        }

        // Инициализируем форму регистрации
        initRegistrationForm();

        // Добавляем кнопку для тестирования (можно удалить в продакшене)
        addTestButton();
    });

    // Инициализация формы регистрации
    function initRegistrationForm() {
        const form = document.getElementById('registerForm');
        if (!form) return;

        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            console.log('Форма регистрации отправлена');

            // Собираем данные формы
            const formData = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                age: parseInt(document.getElementById('age').value),
                lookingFor: document.getElementById('lookingFor').value,
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirmPassword').value,
                preferredAgeRange: document.getElementById('preferredAge').value,
                description: document.getElementById('description').value.trim(),
                interests: selectedInterests.join(', ')
            };

            console.log('Данные формы:', formData);

            // Валидация
            if (!validateForm(formData)) {
                return;
            }

            // Отправка данных на сервер (симуляция)
            registerUser(formData);
        });

        // Валидация формы
        function validateForm(data) {
            // Проверка паролей
            if (data.password !== data.confirmPassword) {
                alert('Пароли не совпадают!');
                return false;
            }

            // Проверка длины пароля
            if (data.password.length < 6) {
                alert('Пароль должен содержать не менее 6 символов!');
                return false;
            }

            // Проверка возраста
            if (data.age < 18 || data.age > 100) {
                alert('Возраст должен быть от 18 до 100 лет!');
                return false;
            }

            // Проверка обязательных полей
            const requiredFields = ['firstName', 'lastName', 'email', 'lookingFor', 'preferredAgeRange'];
            for (const field of requiredFields) {
                if (!data[field]) {
                    alert('Пожалуйста, заполните все обязательные поля!');
                    return false;
                }
            }

            return true;
        }

        // Регистрация пользователя (симуляция)
        async function registerUser(data) {
            try {
                console.log('Отправляем данные регистрации...');

                // Создаем объект пользователя
                const user = {
                    FirstName: data.firstName,
                    LastName: data.lastName,
                    Age: data.age,
                    Email: data.email,
                    Password: data.password,
                    ConfirmPassword: data.confirmPassword,
                    Description: data.description,
                    LookingFor: data.lookingFor,
                    PreferredAgeRange: data.preferredAgeRange,
                    Interests: data.interests,
                    CreatedAt: new Date().toISOString()
                };

                // Сохраняем в localStorage (вместо базы данных для демо)
                localStorage.setItem('registeredUser', JSON.stringify(user));

                // Сохраняем в сессию для немедленного входа
                sessionStorage.setItem('currentUser', JSON.stringify({
                    Id: Date.now(),
                    FirstName: user.FirstName,
                    LastName: user.LastName,
                    Email: user.Email
                }));

                console.log('Пользователь зарегистрирован:', user);

                // Показываем успешное сообщение
                alert('Регистрация успешна! Вы будете перенаправлены на главную страницу.');

                // Перенаправляем на главную
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);

            } catch (error) {
                console.error('Ошибка регистрации:', error);
                alert('Произошла ошибка при регистрации. Пожалуйста, попробуйте еще раз.');
            }
        }
    }

    // Функция для тестирования
    function testRegistration() {
        console.log('Тест регистрации: заполняем форму тестовыми данными');

        document.getElementById('firstName').value = 'Иван';
        document.getElementById('lastName').value = 'Иванов';
        document.getElementById('age').value = '25';
        document.getElementById('lookingFor').value = 'Девушку';
        document.getElementById('email').value = 'test@example.com';
        document.getElementById('password').value = '123456';
        document.getElementById('confirmPassword').value = '123456';
        document.getElementById('preferredAge').value = '18-25';
        document.getElementById('description').value = 'Тестовое описание пользователя';

        // Выбираем несколько интересов
        selectedInterests = ['Кино', 'Музыка', 'Спорт', 'Путешествия'];
        updateInterestsDisplay();

        console.log('Форма заполнена тестовыми данными');
    }

    // Добавляем кнопку для тестирования
    function addTestButton() {
        const testBtn = document.createElement('button');
        testBtn.textContent = '📋 Заполнить тестовыми данными';
        testBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 100; font-size: 14px;';
        testBtn.onclick = testRegistration;
        document.body.appendChild(testBtn);
    }

    // Экспортируем функции для тестирования
    window.testRegistration = testRegistration;
    window.showInterestsModal = showInterestsModal;
    window.closeInterestsModal = closeInterestsModal;
    window.toggleInterest = toggleInterest;
    window.saveSelectedInterests = saveSelectedInterests;
    window.updateInterestsDisplay = updateInterestsDisplay;
</script>

@code {
    // Пустой блок кода - вся логика в JavaScript
}