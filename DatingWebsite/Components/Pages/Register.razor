@page "/register"
@rendermode InteractiveServer
@inject IAuthService AuthService
@inject IUserService UserService
@using DatingWebsite.Data.Models

<div style="max-width: 800px; margin: 30px auto;">
    <!-- Карточка регистрации -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden;">
        <!-- Заголовок -->
        <div style="background: #e75480; color: white; padding: 25px 30px;">
            <h2 style="margin: 0; font-size: 28px;">Регистрация</h2>
        </div>

        <!-- Форма -->
        <div style="padding: 30px;">
            <form @onsubmit="HandleRegister">
                <!-- Имя и Фамилия -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Имя *</label>
                        <input type="text" @bind="user.FirstName" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Фамилия *</label>
                        <input type="text" @bind="user.LastName" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                </div>

                <!-- Возраст и Кого ищет -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Возраст *</label>
                        <input type="number" @bind="user.Age" min="18" max="100" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Кого ищу *</label>
                        <select @bind="user.LookingFor" required
                                style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;">
                            <option value="">Выберите...</option>
                            <option value="Друга">Друга</option>
                            <option value="Девушку">Девушку</option>
                            <option value="Парня">Парня</option>
                            <option value="Серьезные отношения">Серьезные отношения</option>
                            <option value="Просто общение">Просто общение</option>
                        </select>
                    </div>
                </div>

                <!-- Email -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Email *</label>
                    <input type="email" @bind="user.Email" required
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                </div>

                <!-- Пароли -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Пароль *</label>
                        <input type="password" @bind="user.Password" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Подтверждение *</label>
                        <input type="password" @bind="user.ConfirmPassword" required
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" />
                    </div>
                </div>

                <!-- Предпочтительный возраст -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Предпочтительный возраст *</label>
                    <select @bind="user.PreferredAgeRange" required
                            style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;">
                        <option value="">Выберите...</option>
                        <option value="18-25">18-25 лет</option>
                        <option value="26-35">26-35 лет</option>
                        <option value="36-45">36-45 лет</option>
                        <option value="46+">46+ лет</option>
                        <option value="Любой">Любой</option>
                    </select>
                </div>

                <!-- О себе -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">О себе</label>
                    <textarea @bind="user.Description" rows="3"
                              style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                </div>

                <!-- Интересы -->
                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Интересы</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" @onclick="OpenInterestsModal"
                                style="background: white; color: #e75480; border: 2px solid #e75480; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <span>🏷️</span>
                            <span>Выбрать интересы</span>
                        </button>
                        @if (selectedInterests.Count > 0)
                        {
                            <span style="background: #e75480; color: white; padding: 5px 12px; border-radius: 20px; margin-left: 15px; font-size: 14px;">
                                Выбрано: @selectedInterests.Count
                            </span>
                        }
                    </div>

                    @if (selectedInterests.Count > 0)
                    {
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Выбранные интересы:</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                @foreach (var interest in selectedInterests)
                                {
                                    <span style="background: #17a2b8; color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px;">
                                        @interest
                                    </span>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Кнопки -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button type="submit"
                            style="background: #e75480; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;">
                        <span style="margin-right: 10px;">📝</span>
                        Зарегистрироваться
                    </button>

                    <NavLink href="/login" style="text-align: center; color: #e75480; text-decoration: none; padding: 10px;">
                        Уже есть аккаунт? Войти
                    </NavLink>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно интересов -->
@if (showInterestsModal)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; width: 90%; max-width: 800px; max-height: 80vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
            <!-- Заголовок модалки -->
            <div style="background: #e75480; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 22px;">Выбор интересов</h3>
                <button @onclick="CloseInterestsModal" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0;">×</button>
            </div>

            <!-- Содержимое модалки -->
            <div style="flex: 1; overflow-y: auto; padding: 20px 30px;">
                @if (availableInterests.Count == 0)
                {
                    <p>Загрузка интересов...</p>
                }
                else
                {
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        @foreach (var interest in availableInterests)
                        {
                            <div style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;"
                                 @onclick="() => ToggleInterest(interest.Name)">
                                <input type="checkbox"
                                       checked="@selectedInterests.Contains(interest.Name)"
                                       style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;" />
                                <span style="flex: 1; cursor: pointer;">@interest.Name</span>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Футер модалки -->
            <div style="padding: 20px 30px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 12px;">
                <button @onclick="CloseInterestsModal"
                        style="background: #6c757d; color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer;">
                    Отмена
                </button>
                <button @onclick="SaveInterests"
                        style="background: #e75480; color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer;">
                    Сохранить
                </button>
            </div>
        </div>
    </div>
}

@code {
    private User user = new User();
    private bool showInterestsModal = false;
    private List<string> selectedInterests = new();
    private List<Interest> availableInterests = new();

    protected override async Task OnInitializedAsync()
    {
        // Загружаем интересы
        availableInterests = await UserService.GetInterestsAsync();
    }

    private void OpenInterestsModal()
    {
        showInterestsModal = true;
    }

    private void CloseInterestsModal()
    {
        showInterestsModal = false;
    }

    private void ToggleInterest(string interestName)
    {
        if (selectedInterests.Contains(interestName))
        {
            selectedInterests.Remove(interestName);
        }
        else
        {
            selectedInterests.Add(interestName);
        }
    }

    private void SaveInterests()
    {
        user.Interests = string.Join(", ", selectedInterests);
        showInterestsModal = false;
    }

    private async Task HandleRegister()
    {
        if (user.Password != user.ConfirmPassword)
        {
            return;
        }

        user.Interests = string.Join(", ", selectedInterests);
        var result = await AuthService.RegisterAsync(user);

        if (result != null)
        {
            // Регистрация успешна - пользователь будет автоматически перенаправлен
        }
    }
}