@page "/search"
<script src="js/users.js"></script>
<script src="js/chat.js"></script>

<div style="max-width: 1200px; margin: 30px auto;">
    <div style="background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 30px;">
        <h2 style="margin: 0 0 30px 0; color: #2c3e50;">Поиск людей</h2>

        <!-- Поисковая строка и фильтры -->
        <div style="margin-bottom: 30px;">
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <input type="text" id="searchInput" placeholder="Введите имя или интересы..."
                       style="flex: 1; padding: 15px; border: 2px solid #e75480; border-radius: 8px; font-size: 16px;" />
                <button onclick="searchUsers()"
                        style="background: #e75480; color: white; border: none; padding: 0 30px; border-radius: 8px; cursor: pointer;">
                    🔍 Поиск
                </button>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <select id="ageFilter" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="">Все возраста</option>
                    <option value="18-25">18-25 лет</option>
                    <option value="26-30">26-30 лет</option>
                    <option value="31+">31+ лет</option>
                </select>

                <select id="lookingForFilter" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="">Все цели</option>
                    <option value="Друзей">Друзей</option>
                    <option value="Общение">Общение</option>
                    <option value="Отношения">Отношения</option>
                </select>

                <button onclick="clearFilters()"
                        style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    ❌ Сбросить
                </button>
            </div>
        </div>

        <!-- Результаты поиска -->
        <div id="usersContainer">
            <!-- Здесь будут отображаться пользователи -->
            <div style="text-align: center; padding: 50px; color: #666;">
                Загрузка пользователей...
            </div>
        </div>

        <!-- Статистика -->
        <div id="stats" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 14px;">
            Найдено: <span id="usersCount">0</span> пользователей
        </div>
    </div>
</div>

<script>
    // ========== ФУНКЦИИ ДЛЯ РАБОТЫ С ПОЛЬЗОВАТЕЛЯМИ ==========
    const USERS_KEY_LOCAL = 'datingWebsiteUsers';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== ПОИСК: Начало загрузки ===');

        // Проверяем авторизацию
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            alert('Для просмотра поиска необходимо войти в систему');
            window.location.href = '/login';
            return;
        }

        // Проверяем, загрузился ли users.js
        if (typeof getAllUsers !== 'undefined') {
            console.log('users.js загружен, использую его функции');
            const users = getAllUsers();
            console.log('Получено пользователей:', users.length);
            displayUsers(users);
        } else {
            console.log('users.js не загружен, использую локальные функции');
            // Используем локальные функции
            const users = getAllUsersLocal();
            displayUsers(users);
        }
    });

    // Локальные функции, если users.js не загрузился
    function getAllUsersLocal() {
        try {
            const usersJson = localStorage.getItem(USERS_KEY_LOCAL) || '[]';
            return JSON.parse(usersJson);
        } catch (error) {
            console.error('Ошибка при получении пользователей:', error);
            return [];
        }
    }

    function getUserById(id) {
        try {
            const users = getAllUsersLocal();
            const idNum = parseInt(id);
            console.log('Ищем пользователя с ID:', id, 'как число:', idNum);
            return users.find(user => parseInt(user.id) === idNum);
        } catch (error) {
            console.error('Ошибка поиска пользователя:', error);
            return null;
        }
    }

    // Функция для отображения пользователей
    function displayUsers(users) {
        const container = document.getElementById('usersContainer');
        const countElement = document.getElementById('usersCount');

        console.log('displayUsers вызвана с', users.length, 'пользователями');

        if (!users || users.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 64px; margin-bottom: 20px;">😔</div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Нет пользователей</h3>
                    <p style="font-size: 16px; margin-bottom: 20px;">
                        Нажмите кнопку ниже чтобы создать тестовых пользователей.
                    </p>
                    <button onclick="createTestUsers()"
                            style="background: #e75480; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        📝 Создать тестовых пользователей
                    </button>
                </div>
            `;
            countElement.textContent = '0';
            return;
        }

        // Обновляем счетчик
        countElement.textContent = users.length;

        // Получаем текущего пользователя
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const currentUserEmail = currentUser.email || '';

        // Создаем карточки пользователей
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;">';

        users.forEach(user => {
            // Не показываем текущего пользователя
            if (user.email === currentUserEmail) {
                return;
            }

            const firstName = user.firstName || '';
            const lastName = user.lastName || '';
            const initials = (firstName && lastName)
                ? (firstName[0] + lastName[0]).toUpperCase()
                : '??';

            const interests = (user.interests || []).slice(0, 3).map(interest =>
                `<span style="background: #17a2b8; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px;">${interest}</span>`
            ).join('');

            // БЕЗОПАСНЫЙ HTML - используем кавычки для ID!
            html += `
                <div style="background: #f8f9fa; border-radius: 12px; padding: 25px; border: 1px solid #eee; transition: transform 0.3s; cursor: pointer;"
                     onclick="openUserProfile('${user.id}')"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">

                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 60px; height: 60px; background: #e75480; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px;">
                            ${initials}
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #2c3e50;">
                                ${lastName} ${firstName}
                            </div>
                            <div style="color: #666; font-size: 14px;">${user.age || '?'} лет</div>
                            <div style="color: #666; font-size: 12px;">Ищет: ${user.lookingFor || 'Не указано'}</div>
                        </div>
                    </div>

                    <p style="color: #666; margin-bottom: 15px; line-height: 1.5;">${user.description || 'Нет описания'}</p>

                    <div style="margin-bottom: 20px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Интересы:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${interests || '<span style="color: #888; font-size: 12px;">Не указаны</span>'}
                            ${(user.interests && user.interests.length > 3)
                                ? `<span style="background: #6c757d; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px;">+${user.interests.length - 3}</span>`
                                : ''}
                        </div>
                    </div>

                    <button onclick="event.stopPropagation(); sendMessageToUser('${user.id}')"
                            style="width: 100%; background: #e75480; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                        💬 Написать сообщение
                    </button>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    // Функция для создания тестовых пользователей
    function createTestUsers() {
        console.log('Создаю тестовых пользователей...');

        const testUsers = [
            {
                id: 1,
                firstName: "Анна",
                lastName: "Иванова",
                age: 24,
                email: "anna@example.com",
                description: "Люблю кино, путешествия и спорт. Ищу серьёзные отношения.",
                lookingFor: "Серьезные отношения",
                interests: ["Кино", "Путешествия", "Спорт", "Кулинария"]
            },
            {
                id: 2,
                firstName: "Максим",
                lastName: "Петров",
                age: 28,
                email: "maxim@example.com",
                description: "Программист, увлекаюсь технологиями и книгами. Ищу друзей.",
                lookingFor: "Друзей",
                interests: ["Программирование", "Книги", "Игры", "Музыка"]
            }
        ];

        localStorage.setItem(USERS_KEY_LOCAL, JSON.stringify(testUsers));
        alert('Тестовые пользователи созданы!');
        const users = getAllUsersLocal();
        displayUsers(users);
    }

    // Функция для открытия профиля пользователя
    function openUserProfile(userId) {
        console.log('Открываю профиль пользователя ID:', userId, 'тип:', typeof userId);

        // Получаем пользователя
        const user = getUserById(userId);

        if (!user) {
            alert('Пользователь не найден');
            return;
        }

        // Переходим на страницу профиля
        window.location.href = `/user/${userId}`;
    }

    // Функция отправки сообщения - ТОЛЬКО ОДНА ФУНКЦИЯ!
    function sendMessageToUser(userId) {
        if (event) event.stopPropagation();

        console.log('Отправка сообщения пользователю ID:', userId);

        // Получаем пользователя
        const user = getUserById(userId);

        if (!user) {
            alert('Пользователь не найден');
            return;
        }

        // Пытаемся использовать функцию из chat.js
        if (typeof getOrCreateChat !== 'undefined') {
            console.log('Использую getOrCreateChat из chat.js');
            try {
                const chat = getOrCreateChat(userId, `${user.firstName} ${user.lastName}`);
                console.log('Чат создан/найден:', chat);
                window.location.href = `/chat/${chat.id}`;
                return;
            } catch (error) {
                console.error('Ошибка при создании чата через chat.js:', error);
            }
        }

        // Резервный вариант: создаем чат вручную
        console.log('Создаю чат вручную');
        const chatsJson = localStorage.getItem('datingWebsiteChats') || '[]';
        let chats = JSON.parse(chatsJson);

        // Ищем существующий чат
        let chat = chats.find(c => String(c.userId) === String(userId));

        if (!chat) {
            // Создаем новый чат
            chat = {
                id: Date.now().toString(),
                userId: userId.toString(),
                userName: `${user.firstName} ${user.lastName}`,
                lastMessage: "Привет! 👋",
                lastMessageTime: new Date().toISOString(),
                unreadCount: 0
            };
            chats.push(chat);
            localStorage.setItem('datingWebsiteChats', JSON.stringify(chats));
            console.log('Создан новый чат:', chat);
        }

        console.log('Переход к чату ID:', chat.id);
        window.location.href = `/chat/${chat.id}`;
    }

    // Функция поиска
    function searchUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const ageFilter = document.getElementById('ageFilter').value;
        const lookingForFilter = document.getElementById('lookingForFilter').value;

        // Получаем пользователей
        let users;
        if (typeof getAllUsers !== 'undefined') {
            users = getAllUsers();
        } else {
            users = getAllUsersLocal();
        }

        // Фильтруем пользователей
        const filteredUsers = users.filter(user => {
            // Поиск по имени/фамилии/описанию
            const matchesSearch = !searchTerm ||
                (user.firstName && user.firstName.toLowerCase().includes(searchTerm)) ||
                (user.lastName && user.lastName.toLowerCase().includes(searchTerm)) ||
                (user.description && user.description.toLowerCase().includes(searchTerm)) ||
                (user.interests && user.interests.some(interest =>
                    interest && interest.toLowerCase().includes(searchTerm)));

            // Фильтр по возрасту
            let matchesAge = true;
            if (ageFilter === '18-25') matchesAge = user.age >= 18 && user.age <= 25;
            if (ageFilter === '26-30') matchesAge = user.age >= 26 && user.age <= 30;
            if (ageFilter === '31+') matchesAge = user.age >= 31;

            // Фильтр по цели
            const matchesLookingFor = !lookingForFilter || user.lookingFor === lookingForFilter;

            return matchesSearch && matchesAge && matchesLookingFor;
        });

        displayUsers(filteredUsers);
    }

    // Функция сброса фильтров
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('ageFilter').value = '';
        document.getElementById('lookingForFilter').value = '';

        // Перезагружаем пользователей
        let users;
        if (typeof getAllUsers !== 'undefined') {
            users = getAllUsers();
        } else {
            users = getAllUsersLocal();
        }
        displayUsers(users);
    }
</script>