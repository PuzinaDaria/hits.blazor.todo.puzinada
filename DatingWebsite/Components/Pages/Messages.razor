@page "/messages"

<div style="max-width: 1200px; margin: 30px auto;">
    <div style="background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 30px;">
        <h2 style="margin: 0 0 30px 0; color: #2c3e50;">Сообщения</h2>

        <div id="messagesContainer">
            <!-- Сообщения будут загружены через JavaScript -->
            <div style="text-align: center; padding: 50px; color: #666;">
                Загрузка чатов...
            </div>
        </div>
    </div>
</div>

<script src="/js/users.js"></script>
<script src="/js/chat.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Проверяем авторизацию
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            alert('Для просмотра сообщений необходимо войти в систему');
            window.location.href = '/login';
            return;
        }

        displayMessages();
    });

        function displayMessages() {
        const container = document.getElementById('messagesContainer');
        const chats = getUserChats();

        if (chats.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 64px; margin-bottom: 20px;">💬</div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">У вас пока нет сообщений</h3>
                    <p style="font-size: 16px; margin-bottom: 25px; max-width: 500px; margin-left: auto; margin-right: auto;">
                        Начните общение с другими пользователями, чтобы здесь появились чаты.
                    </p>
                    <a href="/search"
                       style="display: inline-block; background: #e75480; color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-size: 16px; margin-top: 10px;">
                        🔍 Найти людей для общения
                    </a>
                </div>
            `;
            return;
        }

        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;">';

        chats.forEach(chat => {
            const user = getUserById(chat.userId);

            // БЕЗОПАСНОЕ получение инициалов
            let initials = '??';
            if (user) {
                const firstName = user.firstName || '';
                const lastName = user.lastName || '';
                if (firstName && lastName) {
                    initials = (firstName[0] + lastName[0]).toUpperCase();
                } else if (firstName) {
                    initials = firstName[0].toUpperCase();
                } else if (chat.userName) {
                    // Пробуем получить из имени в чате
                    const nameParts = chat.userName.split(' ');
                    if (nameParts.length >= 2) {
                        initials = (nameParts[0][0] + nameParts[1][0]).toUpperCase();
                    } else if (nameParts[0]) {
                        initials = nameParts[0][0].toUpperCase();
                    }
                }
            }

            const time = new Date(chat.lastMessageTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const date = new Date(chat.lastMessageTime).toLocaleDateString();

            // Получаем последнее сообщение (не используем запасной вариант "Нет сообщений")
            let lastMessage = chat.lastMessage || "";
            if (!lastMessage && user) {
                // Если нет lastMessage, но есть пользователь, показываем приветствие
                lastMessage = `Чат с ${user.firstName}`;
            }

            html += `
                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; border: 1px solid #eee; transition: all 0.3s; position: relative;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">

                    <!-- Кнопка удаления (красный крестик в правом верхнем углу) -->
                    <button onclick="deleteThisChat('${chat.id}', event)"
                            style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10;"
                            title="Удалить чат"
                            onmouseover="this.style.transform='scale(1.2)';"
                            onmouseout="this.style.transform='scale(1)';">
                        ×
                    </button>

                    <!-- Основное содержимое чата (кликабельное) -->
                    <div style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;"
                         onclick="openChat(${chat.userId})">
                        <div style="width: 50px; height: 50px; background: #17a2b8; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 15px;">
                            ${initials}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #2c3e50; font-size: 16px;">
                                ${chat.userName}
                            </div>
                            <div style="color: #666; font-size: 13px; margin-top: 3px;">
                                ${lastMessage.length > 40 ? lastMessage.substring(0, 40) + '...' : lastMessage}
                            </div>
                        </div>
                        <div style="text-align: right; text-align: center;">
                            <div style="font-size: 12px; color: #888;">${time}</div>
                            <div style="font-size: 11px; color: #888;">${date}</div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    function openChat(userId) {
        const user = getUserById(userId);
        if (user) {
            // Получаем или создаем чат
            const chat = getOrCreateChat(userId, `${user.firstName} ${user.lastName}`);

            // Переходим на страницу чата
            window.location.href = `/chat/${chat.id}`;
        }
    }

    function deleteThisChat(chatId, event) {
        // Останавливаем всплытие события, чтобы не открывался чат
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        // Подтверждение удаления
        if (!confirm('Удалить этот чат? Все сообщения будут удалены.')) {
            return;
        }

        // Пробуем использовать функцию из chat.js
        if (typeof deleteChat === 'function') {
            deleteChat(chatId);
        } else {
            // Резервный вариант, если chat.js не загружен
            try {
                // Удаляем чат
                const chats = JSON.parse(localStorage.getItem('datingWebsiteChats') || '[]');
                const filteredChats = chats.filter(chat => String(chat.id) !== String(chatId));
                localStorage.setItem('datingWebsiteChats', JSON.stringify(filteredChats));

                // Удаляем сообщения этого чата
                const messages = JSON.parse(localStorage.getItem('datingWebsiteMessages') || '[]');
                const filteredMessages = messages.filter(msg => String(msg.chatId) !== String(chatId));
                localStorage.setItem('datingWebsiteMessages', JSON.stringify(filteredMessages));

                alert('Чат удален!');

                // Обновляем список чатов
                if (typeof displayMessages === 'function') {
                    displayMessages();
                }
            } catch (error) {
                console.error('Ошибка при удалении чата:', error);
                alert('Ошибка при удалении чата');
            }
        }
    }
        // В конец файла Messages.razor добавь:
    function refreshChatsList() {
        console.log('Принудительное обновление списка чатов');

        // Получаем актуальные данные
        const chats = JSON.parse(localStorage.getItem('datingWebsiteChats') || '[]');
        const messages = JSON.parse(localStorage.getItem('datingWebsiteMessages') || '[]');

        console.log('Чатов:', chats.length);
        console.log('Сообщений:', messages.length);

        // Проверяем каждый чат
        chats.forEach((chat, index) => {
            console.log(`Чат ${index + 1}:`, chat.userName, 'последнее сообщение:', chat.lastMessage);

            // Если у чата нет lastMessage, пытаемся найти последнее сообщение
            if (!chat.lastMessage || chat.lastMessage === '') {
                const chatMessages = messages.filter(msg => String(msg.chatId) === String(chat.id));
                if (chatMessages.length > 0) {
                    // Сортируем по времени и берем последнее
                    chatMessages.sort((a, b) => new Date(b.time) - new Date(a.time));
                    const lastMsg = chatMessages[0];
                    chat.lastMessage = lastMsg.text.length > 30 ? lastMsg.text.substring(0, 30) + '...' : lastMsg.text;
                    console.log('Обновлено последнее сообщение для чата:', chat.userName, '->', chat.lastMessage);
                }
            }
        });

        // Сохраняем обновленные чаты
        localStorage.setItem('datingWebsiteChats', JSON.stringify(chats));

        // Перезагружаем список
        displayMessages();
    }

    // Добавляем кнопку обновления в Messages.razor (опционально)
    function addRefreshButton() {
        const container = document.getElementById('messagesContainer');
        if (container) {
            const refreshBtn = document.createElement('button');
            refreshBtn.textContent = '🔄 Обновить список чатов';
            refreshBtn.style.cssText = 'background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px;';
            refreshBtn.onclick = refreshChatsList;
            container.parentNode.insertBefore(refreshBtn, container);
        }
    }

    // Вызываем при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        // ... существующий код ...

        // Добавляем кнопку обновления
        setTimeout(addRefreshButton, 1000);
    });
</script>

<style>
    #messagesContainer > div > div:hover {
        background: white !important;
    }
</style>