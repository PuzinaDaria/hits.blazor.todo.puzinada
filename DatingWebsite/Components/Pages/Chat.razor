@page "/chat/{ChatId}"
@inject NavigationManager Navigation

<div style="max-width: 1000px; margin: 30px auto;">
    <!-- Кнопка назад -->
    <div style="margin-bottom: 20px;">
        <button onclick="goBack()"
                style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
            ← Назад к сообщениям
        </button>
    </div>

    <!-- Окно чата -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden;">
        <!-- Заголовок чата -->
        <div id="chatHeader" style="background: #e75480; color: white; padding: 20px 30px;">
            <h2 style="margin: 0; font-size: 22px;" id="chatUserName">Загрузка...</h2>
        </div>

        <!-- Сообщения -->
        <div style="height: 500px; overflow-y: auto; padding: 20px; background: #f8f9fa;" id="messagesContainer">
            <div style="text-align: center; padding: 50px; color: #666;">
                Загрузка сообщений...
            </div>
        </div>

        <!-- Поле ввода -->
        <div style="padding: 20px 30px; border-top: 1px solid #eee; background: white;">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="messageInput" placeholder="Введите сообщение..."
                       style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                       onkeypress="if(event.key === 'Enter') sendChatMessage()" />
                <button onclick="sendChatMessage()" id="sendButton"
                        style="background: #e75480; color: white; border: none; padding: 0 25px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                    Отправить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Подключаем скрипты с ПРАВИЛЬНЫМИ ПУТЯМИ -->
<script src="/js/users.js"></script>
<script src="/js/chat.js"></script>

<script>
    // Временные функции, если скрипты не загрузились
    if (typeof getUserChats === 'undefined') {
        console.log('chat.js не загружен, создаю временные функции');

            if (typeof getUserChats === 'undefined') {
        console.log('chat.js не загружен, создаю временные функции');

        const getCurrentUserId = () => {
            const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            return user ? user.id : 0;
        };

        function getChatsKey() {
            const userId = getCurrentUserId();
            return `datingWebsiteChats_${userId}`;
        }

        function getMessagesKey() {
            const userId = getCurrentUserId();
            return `datingWebsiteMessages_${userId}`;
        }

        function getUserChats() {
            const chats = JSON.parse(localStorage.getItem(getChatsKey()) || '[]');
            return chats.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
        }

        function getChatMessages(chatId) {
            const allMessages = JSON.parse(localStorage.getItem(getMessagesKey()) || '[]');
            return allMessages
                .filter(msg => String(msg.chatId) === String(chatId))
                .sort((a, b) => new Date(a.time) - new Date(b.time));
        }

        function getOrCreateChat(userId, userName) {
            const chats = JSON.parse(localStorage.getItem(getChatsKey()) || '[]');
            let chat = chats.find(c => String(c.userId) === String(userId));

            if (!chat) {
                chat = {
                    id: Date.now().toString(),
                    userId: userId.toString(),
                    userName: userName,
                    lastMessage: "",
                    lastMessageTime: new Date().toISOString(),
                    unreadCount: 0
                };
                chats.push(chat);
                localStorage.setItem(getChatsKey(), JSON.stringify(chats));
            }
            return chat;
        }

        function getUserById(userId) {
            const users = JSON.parse(localStorage.getItem('datingWebsiteUsers') || '[]');
            return users.find(u => String(u.id) === String(userId));
        }

        function sendMessage(chatId, text, senderId = 0, receiverId) {
            const messages = JSON.parse(localStorage.getItem(getMessagesKey()) || '[]');
            const chats = JSON.parse(localStorage.getItem(getChatsKey()) || '[]');

            const message = {
                id: Date.now(),
                chatId: chatId,
                senderId: senderId,
                receiverId: receiverId,
                text: text,
                time: new Date().toISOString(),
                isRead: false
            };

            messages.push(message);
            localStorage.setItem(getMessagesKey(), JSON.stringify(messages));

            const chatIndex = chats.findIndex(c => String(c.id) === String(chatId));
            if (chatIndex !== -1) {
                chats[chatIndex].lastMessage = text.length > 30 ? text.substring(0, 30) + '...' : text;
                chats[chatIndex].lastMessageTime = new Date().toISOString();
                localStorage.setItem(getChatsKey(), JSON.stringify(chats));
            }

            return message;
        }

        function markMessagesAsRead(chatId) {
            const messages = JSON.parse(localStorage.getItem(getMessagesKey()) || '[]');
            messages.forEach(msg => {
                if (String(msg.chatId) === String(chatId) && msg.senderId !== 0 && !msg.isRead) {
                    msg.isRead = true;
                }
            });
            localStorage.setItem(getMessagesKey(), JSON.stringify(messages));
        }

        function deleteChat(chatId) {
            // Простая реализация для резервного варианта
            const chats = JSON.parse(localStorage.getItem(getChatsKey()) || '[]');
            const filteredChats = chats.filter(chat => String(chat.id) !== String(chatId));
            localStorage.setItem(getChatsKey(), JSON.stringify(filteredChats));

            const messages = JSON.parse(localStorage.getItem(getMessagesKey()) || '[]');
            const filteredMessages = messages.filter(msg => String(msg.chatId) !== String(chatId));
            localStorage.setItem(getMessagesKey(), JSON.stringify(filteredMessages));

            return true;
        }
    }

        function getUserChats() {
            const chats = JSON.parse(localStorage.getItem('datingWebsiteChats') || '[]');
            return chats.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
        }

        function getChatMessages(chatId) {
            const allMessages = JSON.parse(localStorage.getItem('datingWebsiteMessages') || '[]');
            return allMessages
                .filter(msg => String(msg.chatId) === String(chatId))
                .sort((a, b) => new Date(a.time) - new Date(b.time));
        }

        function getOrCreateChat(userId, userName) {
            const chats = JSON.parse(localStorage.getItem('datingWebsiteChats') || '[]');
            let chat = chats.find(c => String(c.userId) === String(userId));

            if (!chat) {
                chat = {
                    id: Date.now().toString(),
                    userId: userId.toString(),
                    userName: userName,
                    lastMessage: "",
                    lastMessageTime: new Date().toISOString(),
                    unreadCount: 0
                };
                chats.push(chat);
                localStorage.setItem('datingWebsiteChats', JSON.stringify(chats));
            }
            return chat;
        }

        function getUserById(userId) {
            const users = JSON.parse(localStorage.getItem('datingWebsiteUsers') || '[]');
            return users.find(u => String(u.id) === String(userId));
        }

        function sendMessage(chatId, text, senderId = 0, receiverId) {
            const messages = JSON.parse(localStorage.getItem('datingWebsiteMessages') || '[]');
            const chats = JSON.parse(localStorage.getItem('datingWebsiteChats') || '[]');

            const message = {
                id: Date.now(),
                chatId: chatId,
                senderId: senderId,
                receiverId: receiverId,
                text: text,
                time: new Date().toISOString(),
                isRead: false
            };

            messages.push(message);
            localStorage.setItem('datingWebsiteMessages', JSON.stringify(messages));

            const chatIndex = chats.findIndex(c => String(c.id) === String(chatId));
            if (chatIndex !== -1) {
                chats[chatIndex].lastMessage = text.length > 30 ? text.substring(0, 30) + '...' : text;
                chats[chatIndex].lastMessageTime = new Date().toISOString();
                localStorage.setItem('datingWebsiteChats', JSON.stringify(chats));
            }

            return message;
        }

        function markMessagesAsRead(chatId) {
            const messages = JSON.parse(localStorage.getItem('datingWebsiteMessages') || '[]');
            messages.forEach(msg => {
                if (String(msg.chatId) === String(chatId) && msg.senderId !== 0 && !msg.isRead) {
                    msg.isRead = true;
                }
            });
            localStorage.setItem('datingWebsiteMessages', JSON.stringify(messages));
        }
    }

    let currentChatId = 0;
    let currentUserId = 0;
    let chatUser = null;

    // ФУНКЦИЯ ЗАГРУЗКИ СООБЩЕНИЙ (должна быть объявлена ПЕРЕД использованием)
    function loadMessages() {
        console.log('Загрузка сообщений для чата ID:', currentChatId);

        const messages = getChatMessages(currentChatId);
        const container = document.getElementById('messagesContainer');

        if (!container) {
            console.error('Контейнер сообщений не найден');
            return;
        }

        // Если нет сообщений
        if (!messages || messages.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 80px 20px; color: #666;">
                    <div style="font-size: 64px; margin-bottom: 20px;">💭</div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Чат пуст</h3>
                    <p style="font-size: 16px; margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto;">
                        Напишите первое сообщение, чтобы начать диалог с этим пользователем.
                    </p>
                </div>
            `;
            return;
        }

        let html = '';

        messages.forEach(message => {
            const isMyMessage = message.senderId === 0;
            const time = new Date(message.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            html += `
                <div style="margin-bottom: 15px; display: flex; ${isMyMessage ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}">
                    <div style="max-width: 70%;">
                        <div style="background: ${isMyMessage ? '#e75480' : '#e9ecef'};
                                    color: ${isMyMessage ? 'white' : '#333'};
                                    padding: 12px 16px;
                                    border-radius: ${isMyMessage ? '18px 18px 4px 18px' : '18px 18px 18px 4px'};
                                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div>${message.text}</div>
                            <div style="font-size: 11px; opacity: 0.7; margin-top: 5px; text-align: right;">
                                ${time} ${message.isRead ? '✓✓' : '✓'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;

        // Прокручиваем вниз
        container.scrollTop = container.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Проверяем авторизацию
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            alert('Для использования чата необходимо войти в систему');
            window.location.href = '/login';
            return;
        }

        // Получаем ID чата из URL
        const path = window.location.pathname;
        const match = path.match(/\/chat\/(\d+)/);

        if (match) {
            currentChatId = match[1];
            loadChat();
        } else {
            alert('Чат не найден');
            window.location.href = '/messages';
        }
    });

    function loadChat() {
        console.log('Загрузка чата ID:', currentChatId, 'тип:', typeof currentChatId);

        // Получаем ВСЕ чаты
        const chats = getUserChats();
        console.log('Все чаты:', chats);

        // Ищем нужный чат (сравниваем как строки)
        const chat = chats.find(c => String(c.id) === String(currentChatId));

        if (!chat) {
            console.error('Чат не найден среди:', chats);
            alert('Чат не найден!');
            window.location.href = '/messages';
            return;
        }

        console.log('Найден чат:', chat);

        // Получаем информацию о пользователе из чата
        currentUserId = chat.userId;
        chatUser = getUserById(currentUserId);

        // Добавляем кнопку удаления в заголовок
        const chatHeader = document.getElementById('chatHeader');
        if (chatHeader) {
            if (chatUser) {
                chatHeader.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <h2 style="margin: 0; font-size: 22px;">${chatUser.firstName} ${chatUser.lastName}</h2>
                        <button onclick="deleteCurrentChat()"
                                style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <span>🗑️</span>
                            <span>Удалить чат</span>
                        </button>
                    </div>
                `;
            } else {
                document.getElementById('chatUserName').textContent = chat.userName;
            }
        }

        // Загружаем сообщения
        loadMessages();

        // Помечаем сообщения как прочитанные
        if (typeof markMessagesAsRead === 'function') {
            markMessagesAsRead(currentChatId);
        }

        // Фокусируемся на поле ввода
        document.getElementById('messageInput').focus();

        // Временно УБИРАЕМ автообновление, пока не починим
        // setInterval(loadMessages, 3000);
    }

        function sendChatMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text) {
            return;
        }

        console.log('Отправка сообщения:', text, 'в чат:', currentChatId);

        // Отправляем сообщение
        const message = sendMessage(currentChatId, text, 0, currentUserId);

        if (!message) {
            console.error('Не удалось отправить сообщение');
            alert('Ошибка отправки сообщения');
            return;
        }

        console.log('Сообщение отправлено:', message);

        // Очищаем поле ввода
        input.value = '';
        input.focus();

        // Немедленно обновляем сообщения
        loadMessages();

        // ОБНОВЛЯЕМ СПИСОК ЧАТОВ на странице сообщений
        updateChatListOnMessagesPage();
    }

    // Функция для обновления списка чатов на странице /messages
    function updateChatListOnMessagesPage() {
        // Если мы находимся на странице /messages, обновляем список
        if (window.location.pathname.includes('/messages') && typeof displayMessages === 'function') {
            displayMessages();
        }

        // Также обновляем, если открыто несколько вкладок
        try {
            // Отправляем событие в localStorage для обновления других вкладок
            localStorage.setItem('chatUpdated', Date.now().toString());
        } catch (e) {
            console.log('Не удалось отправить событие обновления:', e);
        }
    }

    // Слушаем события обновления чатов
    window.addEventListener('storage', function(event) {
        if (event.key === 'chatUpdated' && window.location.pathname.includes('/messages')) {
            console.log('Получено событие обновления чатов');
            if (typeof displayMessages === 'function') {
                displayMessages();
            }
        }
    });

    function goBack() {
        window.location.href = '/messages';
    }

    function deleteCurrentChat() {
        if (!currentChatId) {
            alert('Ошибка: ID чата не найден');
            return;
        }

        if (!confirm('Удалить этот чат? Все сообщения будут удалены без возможности восстановления.')) {
            return;
        }

        // Пробуем использовать функцию из chat.js
        if (typeof deleteChat === 'function') {
            deleteChat(currentChatId);
        } else {
            // Резервный вариант
            try {
                // Удаляем чат
                const chats = JSON.parse(localStorage.getItem('datingWebsiteChats') || '[]');
                const filteredChats = chats.filter(chat => String(chat.id) !== String(currentChatId));
                localStorage.setItem('datingWebsiteChats', JSON.stringify(filteredChats));

                // Удаляем сообщения
                const messages = JSON.parse(localStorage.getItem('datingWebsiteMessages') || '[]');
                const filteredMessages = messages.filter(msg => String(msg.chatId) !== String(currentChatId));
                localStorage.setItem('datingWebsiteMessages', JSON.stringify(filteredMessages));

                alert('Чат удален!');
                window.location.href = '/messages';
            } catch (error) {
                console.error('Ошибка при удалении чата:', error);
                alert('Ошибка при удалении чата');
            }
        }
    }

    // Функция для отладки
    function debugChat() {
        console.log('=== ДЕБАГ ЧАТА ===');
        console.log('currentChatId:', currentChatId);
        console.log('currentUserId:', currentUserId);
        console.log('chatUser:', chatUser);

        const messages = getChatMessages(currentChatId);
        console.log('Сообщения в чате:', messages);
        console.log('Количество сообщений:', messages.length);

        const chats = JSON.parse(localStorage.getItem('datingWebsiteChats') || '[]');
        console.log('Все чаты:', chats);

        const allMessages = JSON.parse(localStorage.getItem('datingWebsiteMessages') || '[]');
        console.log('Все сообщения в системе:', allMessages.length);

        return { messages, chats, allMessages };
    }

    window.debugChat = debugChat;
</script>

@code {
    [Parameter]
    public string ChatId { get; set; }
}